name: Daily Lighthouse Audit
on:
  schedule:
    - cron: "32 3 * * *"
  workflow_dispatch:

jobs:
  psi-audit:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Fetch Score from Google API (Best of 3)
        id: psi
        run: |
          URL="https://rachel-demo.oxypteros.com"
          API_KEY="${{ secrets.PAGESPEED_API_KEY }}"
          MAX_SCORE=0
          
          echo "ðŸš€ Starting Lighthouse Audit (Best of 3)..."

          for i in {1..3}
          do
            echo "Attempt $i/3..."
            
            # Run the audit
            RESPONSE=$(curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=$URL&strategy=mobile&category=performance&key=$API_KEY")
            
            # Extract Score (0 to 1)
            SCORE_RAW=$(echo $RESPONSE | jq '.lighthouseResult.categories.performance.score')

            # Error handling
            if [ "$SCORE_RAW" == "null" ] || [ -z "$SCORE_RAW" ]; then
               echo "âŒ Error: Could not fetch score on attempt $i."
               continue
            fi

            # Convert 0.93 to 93
            CURRENT_SCORE=$(echo "$SCORE_RAW * 100" | bc | awk '{print int($1+0.5)}')
            echo "ðŸ“Š Run $i Score: $CURRENT_SCORE"

            # Update Max Score
            if [ "$CURRENT_SCORE" -gt "$MAX_SCORE" ]; then
              MAX_SCORE=$CURRENT_SCORE
            fi

            # Small sleep between runs
            if [ $i -lt 3 ]; then
              echo "ðŸ’¤ Cooling down for 13 seconds..."
              sleep 13
            fi
          done
          
          if [ "$MAX_SCORE" -eq "0" ]; then
             echo "âŒ Failed to get any valid score."
             exit 1
          fi

          echo "ðŸ† Final Selected Score: $MAX_SCORE"
          echo "score=$MAX_SCORE" >> $GITHUB_OUTPUT

      - name: Generate SVG Badge
        env:
          SCORE: ${{ steps.psi.outputs.score }}
        run: |
          COLOR="red"
          if (( $SCORE >= 90 )); then COLOR="266429"; fi
          if (( $SCORE >= 50 && $SCORE < 90 )); then COLOR="orange"; fi

          mkdir -p .github/badges
          # Download the Badge as an SVG image
          curl "https://img.shields.io/badge/PageSpeed-$SCORE-$COLOR?style=flat&logo=pagespeedinsights&logoColor=%234285F4&labelColor=%23F0F0F0" > .github/badges/lighthouse.svg

      - name: Commit Badge
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ¤– Update Lighthouse Badge: ${{ steps.psi.outputs.score }} [skip ci]"
          file_pattern: .github/badges/lighthouse.svg